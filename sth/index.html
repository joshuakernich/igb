<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Stranger Things</title>
	<script type="text/javascript" src="../shared/jq.js"></script>
	<script type="text/javascript">
		$(function(){
			$(document).on('mousemove',onMove);

			let w = $('screen').width();
			let isThrowing = false;
			let $projectile;
			let $locked;
			let layerTime;
			let layerProgress;
			let yTarget = 0;
			let scale = 1;
			let iLayerJump;

			let xTarget;

			

			function onMove(e){
				xTarget = e.pageX - $('screen').offset().left;
			}

			function tick(){
				let amt = xTarget/w - 0.5;
				let isHitting = false;

				$('target').css('left',xTarget);
				$projectile.css('left',xTarget);
				
				if(!isThrowing){
					
					$projectile.find('inner').css('transform','rotate('+amt*70+'deg)');

					if( $('demogorgon').attr('pose') == 'static' || $('demogorgon').attr('pose') == 'climb' ){
						let dist = $('demogorgon').position().left - xTarget;
						
						
						if(dist<20 && dist>-20) isHitting = true;
					}
				} 

				if(isHitting) nLocked--;
				else if(nLocked<ticksLock) nLocked++;

				if(!isThrowing) $('locked').css('transform','scale('+(1+nLocked*0.2)+')')

				if(isHitting && nLocked<=0){
					let y = $('target').offset().top - $('screen').offset().top;
					doThrow(y);
				}
			}

			let timeLock =  150;
			let timeClimb = 750;
			let timeJump = 1000;

			let ticksPerSecond = 50;
			
			let ticksLock = timeLock/ticksPerSecond;
			let nLocked = ticksLock;

			setInterval(tick,1000/ticksPerSecond);

			

			function redrawProjectile(val,obj){


				let maxAt = 550;
				let minAt = 0;
				let pos = (val-minAt)/(maxAt-minAt);
	
				let scale = 0.2 + pos * 0.8;

				

				$projectile.css('transform','scale('+scale+')');
				$projectile.find('inner').css({
					'top':-Math.sin(obj.pos*Math.PI)*400,
					'transform':'rotate('+obj.pos*270+'deg)',
				})
			}

			function doThrow(y){

				//$locked = $('<locked>').appendTo('body').offset($('target').offset());

				isThrowing = true;
				let duration = 1000-y;
				$projectile.animate({ top:y },{ easing:'linear', duration:duration, step:redrawProjectile, complete:onThrowComplete });
			}

			let isTriggeredByLayer = false;


			function onThrowComplete(){
				if($projectile){
					
					if( $('demogorgon').attr('pose') == 'static' || $('demogorgon').attr('pose') == 'climb' ){
						let dist = $('demogorgon').offset().left - $projectile.offset().left;
						let y = $('target').offset().top - $('screen').offset().top;
						if(dist<50 && dist>-50) hitDemogorgon();
					}

					$projectile.remove();

				}
				setTimeout(newProjectile,500);
			}

			function hitDemogorgon(){

				clearTimeout(iLayerJump);

				let x = $('demogorgon').position().left;
				$('demogorgon')
				.animate({left:x-5},20)
				.animate({left:x+5},20)
				.animate({left:x-5},20)
				.animate({left:x+5},20)
				.animate({left:x},{duration:20,complete:queueHide})
			}

			function newProjectile() {

				if($projectile) $projectile.remove();
				if($locked) $locked.remove();

				

				isThrowing = false;
				isTriggeredByLayer = false;
				$projectile = $(`<projectile>
				<inner></inner>
				<smash></smash>
				</projectile>`).appendTo('screen');

				$projectile.css({top:550,transform:'scale(1) rotate(0deg)'});
				
			}



			function onLayerUpdate(a,obj) {
				//layerProgress = obj.pos;
			}

			function queuePop(){
				let $obstacle = $('layer').eq(nLayer).find('obstacle').eq(nObstacle);
				let x = $obstacle.position().left + Math.random()*$obstacle.width();
				$('demogorgon').attr('pose','static').animate({left:x},100);

				iLayerJump = setTimeout(doClimb,timeClimb);
			}

			function doClimb() {
				$('demogorgon').attr('pose','climb');
				iLayerJump = setTimeout(doNextLayer,timeJump);
			}

			function queueHide(){
				nObstacle = Math.floor(Math.random()*$('layer').eq(nLayer).find('obstacle').length);
				toObstacle( nObstacle );
			}

			function queueWave(){
				$('demogorgon').attr('pose','wave');
				queueRandom();
			}

			function queueFakeout(){

				let $obstacle = $('layer').eq(nLayer).find('obstacle').eq(nObstacle);
				let x = $obstacle.position().left + Math.random()*$obstacle.width();
				$('demogorgon').attr('pose','fakeout').animate({left:x},100);

				setTimeout( function(){
					$('demogorgon').attr('pose','crouch');
				},500);

				setTimeout( queuePop, 800 );
			}

			let whatNexts = [queuePop,queueHide,queueWave,queueFakeout];

			function queueRandom(){
				let whatNext = whatNexts[ Math.floor(Math.random()*whatNexts.length) ];
				setTimeout( whatNext, 50 + Math.random()*1000 );
			}

			function atObstacle(){
				queueRandom();
			}

			function toObstacle(nObstacle){
				let $obstacle = $('layer').eq(nLayer).find('obstacle').eq(nObstacle);

				$('demogorgon').attr('pose','crouch');

				$('demogorgon').animate(
					{
						left:$obstacle.position().left + $obstacle.width()/2
					},
					{
						duration: 1000,
						easing:'swing',
						complete:atObstacle,
					});
				
			}

			let nObstacle = -1;
			function toNextObstacle(){
				nObstacle++;
				toObstacle(nObstacle);
			}

			function toPrevObstacle(){
				nObstacle--;
				toObstacle(nObstacle);
			}

			function doNextLayer(){
				nObstacle = -1;
				doLayer(nLayer+1);
			}

			function doLayer(n) {

				nLayer = n;

				layerDuration = 10000-(n*2000);
				yTarget = 150+n*100;
				scale = (1+n);
				

				$('target').appendTo($('layer').eq(n)).css({transform:'scale('+scale+')'});

				$('demogorgon')
				.attr('pose','dodge')
				.prependTo($('layer').eq(n))
				.css({transform:'scale('+scale+')'});


				if( $('layer').eq(nLayer).find('obstacle').length ) setTimeout( toNextObstacle, 500);
				

			}

			
			doLayer(0);
			newProjectile();
		})
	</script>
	<style type="text/css">
		body{
			background: #222;
			text-align: center;
		}

		info{
			position: fixed;
			top: 0px;
			left: 0px;
			display: block;
			font-family: sans-serif;
			padding: 10px;
			width: 250px;
			border: 1px solid black;
			margin: 10px;
			background: white;
			text-align: left;
		}

		screen{
			width: 1024px;
			height: 576px;
			background: #777;
			display: inline-block;
			margin: 20px;
			position: relative;
			overflow: hidden;
		}

		target{
			position: absolute;
			top: -45%;
		}




		reticule, locked{
			
			width: 20px;
			height: 20px;
			
			border: 2px solid red;
			position: absolute;
			left: -10px;
			top: -10px;
			box-sizing: border-box;
			border-radius: 100px;

			
		}

		locked{
			border: 0.5px solid red;
		}

		demogorgon{
			position: absolute;
			bottom: 15%;
		}

		
		demogorgon:after{
			content: "";
			background-image:url("./demo-static.png");
			width: 100px;
			height: 100px;
			background-size: 100%;
			background-position: bottom center;
			background-repeat: no-repeat;
			display: inline-block;
			position: absolute;
			left: -50px;
			bottom: 0px;
		}

		demogorgon[pose=dodge]:after{
			background-image:url("./demo-dodge.png");
			
		}

		demogorgon[pose=climb]:after{
			background-image:url("./demo-climb.png");
			
		}

		demogorgon[pose=crouch]:after{
			background-image:url("./demo-crouch.png");
			
		}

		demogorgon[pose=wave]:after{
			background-image:url("./demo-wave.png");
			
		}

		demogorgon[pose=fakeout]:after{
			background-image:url("./demo-fakeout.png");
			
		}

		projectile{
			position: absolute;
			top: 550px;
		}

		/*projectile:before{
			content: "";
			width: 50px;
			height: 50px;
			border-radius: 100px;
			background: black;
			position: absolute;
			left: -25px;
			top: -25px;
			transform: scaleY(0.3);
			opacity: 0.3;
		}*/

		inner{
			position: absolute;
			top: 0px;
		}

		inner:after{
			content: "";
			background-image:url("./bottle.png");
			width: 200px;
			height: 200px;
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			display: inline-block;
			position: absolute;
			left: -100px;
			bottom: -100px;
		}

		smash{
			position: absolute;
			/*background: url(https://cdn-icons-png.flaticon.com/512/8819/8819076.png);*/
			
			width: 400px;
			height: 400px;
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			display: inline-block;
			position: absolute;
			left: -200px;
			bottom: -200px;
		}

		layer{
			text-align: center;
			height: 60px;
			display: block;
			
			margin: 0px 0px;
			position: relative;
		}

		obstacle{
			width: 200px;
			height: 120%;
			display: inline-block;
			margin: 0px 30px;
			background: #ddd;
			position: relative;
			border-radius: 50px 50px 5px 5px;
			position: relative;
			top: -20%;
			box-shadow: 0px -5px 10px rgba(0,0,0,0.2);
		}

		
	</style>
</head>
<body>
	<screen>
		<target>
			<reticule></reticule>
			<locked></locked>
		</target>
		<demogorgon class='crouch'>
			<demobody></demobody>
			<demohead></demohead>
		</demogorgon>
		<layer style='margin-top:100px;'>
			<obstacle></obstacle>
			<obstacle></obstacle>
			<obstacle></obstacle>
		</layer>
		<layer style="height:100px">
			<obstacle style='width:300px;'></obstacle>
			<obstacle style='width:350px;'></obstacle>
		</layer>
		<layer style="height:150px">
		
			<obstacle style='width:550px;'></obstacle>
		</layer>
		<layer>
		</layer>
	</screen>

	<info>
		<p>Move left-to-right to attack.</p>
		<p>
			<p>TIMINGS TO TWEAK:</p>
			<ul>
				<li>Vulnerability time (V): 1.75s</li>
				<li>Target lock delay (L): 0.15s</li>
				<li>Throw time per layer (T):<br>0.9s, 0.85, 0.8s</li>
				<li>Player reaction time:<br> V - L - T = <br>< 1 second (approx)</li>
			</ul>
			<p>VARIABLES TO TWEAK:</p>
			<ul>
				<li>Proximity for targeting lock</li>
				<li>Demogorgon behaviours</li>
				<li>Demodog Minions?</li>
			</ul>
			<p>STATES:</p>
			<ul>
				<li>Scurry</li>
				<li>Pop-up</li>
				<li>Climb</li>
				<li>Dodge</li>
				<li>Peak</li>
				<li>Wave</li>
				<li>Maybe throw things at us</li>
			</ul>

		</p>

	</info>
</body>
</html>