<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Stranger Things</title>
	<script type="text/javascript" src="../shared/jq.js"></script>
	<script type="text/javascript">
		$(function(){
			$(document).on('mousemove',onMove);

			let w = $('screen').width();
			let isThrowing = false;
			let $projectile;
			let $locked;
			let layerTime;
			let layerProgress;
			let scale = 1;
			let iLayerJump;

			let xTarget;
			let hitsOnLayer = 0;
			let isTargeting = false;

			let timeLock =  1000;
			let timeClimb = 1000;
			let timeJump = 1500;
			let ticksPerSecond = 50;
			let ticksLock = timeLock/ticksPerSecond;
			let nLocked = ticksLock;
			let DISTANCE = 40;

			
			function onMove(e){
				xTarget = e.pageX - $('screen').offset().left;
			}

			function tick(){
				let amt = xTarget/w - 0.5;
				let isHitting = false;

				$('.me').css('left',xTarget);
				$projectile.css('left',xTarget);
				
				if(!isThrowing){
					
					$projectile.find('inner').css('transform','rotate('+amt*70+'deg)');

					if( isTargeting ){
						let dist = $('demogorgon').position().left - xTarget;
						if(dist<DISTANCE && dist>-DISTANCE) isHitting = true;
					}
				} 

				if(isHitting) nLocked--;
				else if(nLocked<ticksLock) nLocked++;

				if(!isThrowing) $('locked').css('transform','scale('+(1+nLocked*0.1)+')')

				if(isHitting && nLocked<=0){

					let y = $('target').offset().top - $('screen').offset().top;
					doThrow(y);
				}
			}

			

			setInterval(tick,1000/ticksPerSecond);


			function redrawProjectile(val,obj){

				let maxAt = 550;
				let minAt = 0;
				let pos = (val-minAt)/(maxAt-minAt);
	
				let scale = pos * 1;

				$projectile.css('transform','scale('+scale+')');
				$projectile.find('inner').css({
					'top':-Math.sin(obj.pos*Math.PI)*600,
					'transform':'rotate('+obj.pos*270+'deg)',
				})
			}

			function doThrow(y){
				isTargeting = false;
				$('target').hide();
				isThrowing = true;
				let duration = 900 - nLayer*100;
				$projectile.animate({ top:y },{ easing:'linear', duration:duration, step:redrawProjectile, complete:onThrowComplete });
			}

			let isTriggeredByLayer = false;

			function onThrowComplete(){
				if($projectile){
					
					if( $('demogorgon').attr('pose') == 'static' || $('demogorgon').attr('pose') == 'climb' ){
						let dist = $('demogorgon').offset().left - $projectile.offset().left;
						let y = $('target').offset().top - $('screen').offset().top;
						if(dist<50 && dist>-50) hitDemogorgon();
					}

					$projectile.remove();

				}
				setTimeout(newProjectile,500);
			}

			function hitDemogorgon(){

				hitsOnLayer++;

				clearTimeout(iLayerJump);

				let x = $('demogorgon').position().left;
				$('demogorgon')
				.animate({left:x-5},20)
				.animate({left:x+5},20)
				.animate({left:x-5},20)
				.animate({left:x+5},20)
				.animate({left:x},{duration:20,complete:queueHide})
			}

			function newProjectile() {

				if($projectile) $projectile.remove();
				if($locked) $locked.remove();

				

				isThrowing = false;
				isTriggeredByLayer = false;
				$projectile = $(`<projectile>
				<inner></inner>
				<smash></smash>
				</projectile>`).appendTo('screen');

				$projectile.css({top:550,transform:'scale(1) rotate(0deg)'});
				
			}



			function onLayerUpdate(a,obj) {
				//layerProgress = obj.pos;
			}

			function queuePop(){

				let x = getRandomX();
				$('demogorgon').attr('pose','static').css({left:x});
				

				setTimeout(function(){
					$('.them').css({left:x}).show();
					$('target').show();
					isTargeting = true;
				},500)

				iLayerJump = setTimeout(doClimb,500+timeClimb);
			}

			function doClimb() {
				$('demogorgon').attr('pose','climb');
				iLayerJump = setTimeout(doNextLayer,timeJump-hitsOnLayer*100);
			}

			function queueHide(){
				nObstacle = Math.floor(Math.random()*$('layer').eq(nLayer).find('obstacle').length);
				toObstacle( nObstacle );
			}

			function getRandomX(){
				let $obstacle = $('layer').eq(nLayer).find('obstacle').eq(nObstacle);
				return $obstacle.position().left + $obstacle.width()*0.1 + Math.random()*$obstacle.width()*0.8;
			}

			function queueWave(){

				$('demogorgon').attr('pose','wave').css({left:getRandomX()});
				
				setTimeout( function(){
					$('demogorgon').attr('pose','crouch');
					queueRandom();
				},500);

			}

			function queueFakeout(){

				$('demogorgon').attr('pose','fakeout').css({left:getRandomX()});

				setTimeout( function(){
					$('demogorgon').attr('pose','crouch');
					queueRandom();
				},500);
			}

			let libraryOfMoves = [queuePop,queueHide,queueWave,queueFakeout];
			let whatNexts = [];

			function shuffle(array) {
			  let currentIndex = array.length, randomIndex;

			  // While there remain elements to shuffle.
			  while (currentIndex > 0) {

			    // Pick a remaining element.
			    randomIndex = Math.floor(Math.random() * currentIndex);
			    currentIndex--;

			    // And swap it with the current element.
			    [array[currentIndex], array[randomIndex]] = [
			      array[randomIndex], array[currentIndex]];
			  }

			  return array;
			}


			function queueRandom(){
				if(!whatNexts.length) whatNexts = shuffle(libraryOfMoves.concat());
				let whatNext = whatNexts.pop();
				console.log(whatNext);
				setTimeout( whatNext, 150 + Math.random()*1000 );
			}

			function atObstacle(){
				queueRandom();
			}

			function toObstacle(nObstacle){
				let $obstacle = $('layer').eq(nLayer).find('obstacle').eq(nObstacle);

				$('demogorgon').attr('pose','crouch');

				$('demogorgon').animate(
					{
						left:$obstacle.position().left + $obstacle.width()/2
					},
					{
						duration: 1000,
						easing:'swing',
						complete:atObstacle,
					});
				
			}

			let nObstacle = -1;
			function toNextObstacle(){
				nObstacle++;
				toObstacle(nObstacle);
			}

			function toPrevObstacle(){
				nObstacle--;
				toObstacle(nObstacle);
			}

			function doNextLayer(){

				nObstacle = -1;
				doLayer(nLayer+1);
			}

			function doLayer(n) {

				hitsOnLayer = 0;
				isTargeting = false;
				nLocked = ticksLock;

				$('target').hide();

				nLayer = n;
				scale = (1+n);
				

				$('target').appendTo($('layer').eq(n));//.css({transform:'scale('+scale+')'});

				$('demogorgon')
				.attr('pose','dodge')
				.prependTo($('layer').eq(n))
				.css({transform:'scale('+scale+')'});


				if( $('layer').eq(nLayer).find('obstacle').length ) setTimeout( toNextObstacle, 500);
				

			}

			function doMessage(x,y,text){
				$('<message>').text(text).css({left:x,top:y}).appendTo('screen');
			}

			
			doLayer(0);
			newProjectile();
		})
	</script>
	<style type="text/css">
		message{
			display: block;
		}
		body{
			background: #222;
			text-align: center;
		}

		p{
			margin-top: 0px;
		}

		info{
			position: absolute;
			top: 0px;
			left: 0px;
			display: block;
			font-family: sans-serif;
			padding: 10px;
			width: 250px;
			border: 1px solid black;
			top: 0px;
			bottom: 0px;
			height: 576px;
			margin: auto;
			background: white;
			text-align: left;
			font-size: 12px;
			box-sizing: border-box;
		}

		screen{
			width: 1024px;
			height: 576px;
			background: #777;
			display: inline-block;
			margin: 20px;
			position: absolute;
			overflow: hidden;
			left: 250px;
			top: 0px;
			bottom: 0px;
			right: 0px;
			margin: auto;
			cursor: none;
		}

		target{
			position: absolute;
			top: -50%;
		}




		reticule, locked{
			
			width: 40px;
			height: 40px;
			
			border: 2px solid white;
			position: absolute;
			left: -20px;
			top: -20px;
			box-sizing: border-box;
			border-radius: 100px;
			
			
		
		}

		reticule{
			background: rgba(255,0,0,0.3);
			box-shadow: 0px 0px 5px black;
		}


		locked{
			border: 0.5px dashed white;

		}

		demogorgon{
			position: absolute;
			bottom: 15%;
		}

		
		demogorgon:after{
			content: "";
			background-image:url("./demo-static.png");
			width: 100px;
			height: 100px;
			background-size: 100%;
			background-position: bottom center;
			background-repeat: no-repeat;
			display: inline-block;
			position: absolute;
			left: -50px;
			bottom: 0px;
		}

		demogorgon[pose=dodge]:after{
			background-image:url("./demo-dodge.png");
			
		}

		demogorgon[pose=climb]:after{
			background-image:url("./demo-climb.png");
			
		}

		demogorgon[pose=crouch]:after{
			background-image:url("./demo-crouch.png");
			
		}

		demogorgon[pose=wave]:after{
			background-image:url("./demo-wave.png");
			
		}

		demogorgon[pose=fakeout]:after{
			background-image:url("./demo-fakeout.png");
			
		}

		projectile{
			position: absolute;
			top: 550px;
		}

		
		inner{
			position: absolute;
			top: 0px;
		}

		inner:after{
			content: "";
			background-image:url("./bottle.png");
			width: 400px;
			height: 400px;
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			display: inline-block;
			position: absolute;
			left: -200px;
			bottom: -200px;
		}

		smash{
			position: absolute;
			/*background: url(https://cdn-icons-png.flaticon.com/512/8819/8819076.png);*/
			
			width: 400px;
			height: 400px;
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			display: inline-block;
			position: absolute;
			left: -200px;
			bottom: -200px;
		}

		layer{
			text-align: center;
			height: 60px;
			display: block;
			
			margin: 0px 0px;
			position: relative;
		}

		obstacle{
			width: 250px;
			height: 120%;
			display: inline-block;
			margin: 0px 30px;
			background: #ddd;
			position: relative;
			border-radius: 20px 20px 5px 5px;
			position: relative;
			top: -20%;
			box-shadow: 0px -5px 10px rgba(0,0,0,0.2);
		}

		h2{
			font-weight: normal;
			margin: 0px;
		}

		
	</style>
</head>
<body>
	<screen>
		<target class='me'>
			<reticule></reticule>
			<locked></locked>
		</target>
		<target class='them'>
			<reticule></reticule>
		</target>
		<demogorgon class='crouch'>
			<demobody></demobody>
			<demohead></demohead>
		</demogorgon>
		<layer style='height:55px;margin-top:100px;'>
			<obstacle></obstacle>
			<obstacle></obstacle>
			<obstacle></obstacle>
		</layer>
		<layer style="height:110px">
			<obstacle style='width:400px;'></obstacle>
			<obstacle style='width:400px;'></obstacle>
		</layer>
		<layer style="height:165px">
		
			<obstacle style='width:650px;'></obstacle>
		</layer>
		<layer>
		</layer>
	</screen>

	<info>
		<h2>Controls</h2>
		<ul>
			<li>Move left-to-right to aim</li>
			<li>Reticule appears when vulnerable</li>
			<li>Target appears when vulnerable</li>
			<li>Target and reticule must touch for 0.5 seconds to throw</li>
		</ul>

		<h2>Timings</h2>
		<ul>
			<li>Vulnerability time (V):<br>2.5s - 0.1s for each hit on a layer</li>
			<li>Target lock delay (L): 1s</li>
			<li>Throw time per layer (T):<br>0.9s, 0.8, 0.7s</li>
			<li>Player reaction time:<br> V - L - T = <br>0.3 to 0.5 seconds</li>
		</ul>
		<h2>Variables</h2>
		<ul>
			<li>Proximity for targeting lock</li>
			<li>Demogorgon behaviours</li>
			<li>Demodog Minions?</li>
		</ul>
		<h2>States</h2>
		<p>Use a randomised bag of:</p>
		<ol>
			<li>Scurry between obstacles</li>
			<li>Peak momentarily</li>
			<li>Wave momentarily</li>
			<li>Pop-up, roar, and jump layer (vulnerable sequence)</li>
			<li>Maybe throw something?</li>
		</ol>

	

	</info>
</body>
</html>